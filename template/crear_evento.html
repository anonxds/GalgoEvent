<!DOCTYPE html>
{% load static %}

<html lang="en">
<head>
<title>Maruti Admin</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="{% static 'css/bootstrap.min.css'%}" />
<link rel="stylesheet" href="{% static 'css/bootstrap-responsive.min.css'%}" />
<link rel="stylesheet" href="{% static 'css/fullcalendar.css'%}" />
<link rel="stylesheet" href="{% static 'css/maruti-style.css'%}" />
<link rel="stylesheet" href="{% static 'css/maruti-media.css'%}" class="skin-color" />
</head>
<body>

<!--Header-part-->
<div id="header">
  <h1><a href="dashboard.html">Maruti Admin</a></h1>
</div>
<!--close-Header-part--> 

<!--top-Header-messaages-->
<div class="btn-group rightzero"> <a class="top_message tip-left" title="Manage Files"><i class="icon-file"></i></a> <a class="top_message tip-bottom" title="Manage Users"><i class="icon-user"></i></a> <a class="top_message tip-bottom" title="Manage Comments"><i class="icon-comment"></i><span class="label label-important">5</span></a> <a class="top_message tip-bottom" title="Manage Orders"><i class="icon-shopping-cart"></i></a> </div>
<!--close-top-Header-messaages--> 

<!--top-Header-menu-->
<div id="user-nav" class="navbar navbar-inverse">
  <ul class="nav">
     <li class=""><a title="" href="login.html"><i class="icon icon-share-alt"></i> <span class="text">Logout</span></a></li>
  </ul>
</div>

<!--close-top-Header-menu-->

<div id="sidebar"><a href="#" class="visible-phone"><i class="icon icon-home"></i> Dashboard</a><ul>
  <li class="active"><a href="{% url 'index' %}"><i class="icon icon-home"></i> <span>Home</span></a> </li>
    <li class="active"><a href="{% url 'crear_evento' %}"><i class="icon icon-globe"></i> <span>Crear &amp; Eventos</span></a> </li>
    <li> <a href="{% url 'ver_eventos' %}"><i class="icon icon-pencil"></i> <span>Editar &amp; Eventos</span></a> </li>
    <li> <a href="{% url 'ver_eventos' %}"><i class="icon-info-sign"></i> <span>Ayuda</span></a> </li>

  </ul>
</div>
<div id="content">
  <div id="content-header">
  </div>
  <div class="container-fluid"> 
    <div class="row-fluid">
      <div class="span6">
        <div class="widget-box">
          <div class="widget-title"><span class="icon"><i class="icon-bullhorn"></i></span>
            <h5>Nuevo Evento</h5>
          </div>
          <div class="widget-content">
            <form action="" id="create_event">
              {% csrf_token %}
            <h5>Paso 1: Nombra el evento</h5>
            <input id='titulo' maxlength="20" required>
            <hr>
            <h5>Paso 2: Anade una descripcion</h5>
            <textarea style="width: 500px;" id='descripcion' required maxlength="200"></textarea>
            
            <hr>
            <h5>Paso 3: Subir una imagen</h5>
            <input type="hidden" name="url" id="url">
            <input type="file" name="files" id="files" accept="image/*"  required>
            <img height="331" width="981" id="preview" src="#">
            <hr>
            <h5>Paso 4: Selecciona donde mostrarlo</h5>
            <p>Selecciona una ubicacion donde quiera que aparesca el evento. Una vez terminado el <br>
            evento se vera reflejado en la aplicacion</p>
            <select id='escuela' required>
                <option value="">Seleccionar</option>
                <option value="tomas_aquino">Tomas Aquino</option>
                <option value="Otay">Otay</option>
            </select>
            <select id='g_ubicacion' name='g_ubicacion' required>
               
            </select>
            <hr>
            <button id="crear" type="submit" class="btn btn-success">Crear!</button>
          </form>
          </div>
        </div>
      </div>
      <div class="span6">
        <div class="widget-box">
          <div class="widget-title"><span class="icon"><i class="icon-film"></i></span>
            <h5>Vista previa</h5>
          </div>
          <div class="widget-content">
            <h5 id="v_titulo" style="text-align: center;">Titulo</h5>
            <img id='v_preview'height="331" width="981" src="https://upload.wikimedia.org/wikipedia/commons/f/f9/Phoenicopterus_ruber_in_S%C3%A3o_Paulo_Zoo.jpg">
            <p id="v_descripcion" style="text-align: center;">Description clara, de mi vida, cuando tenia 6 anos naci sin rostro</p>
          </div>
        </div>
      </div>
    </div>
    <hr>
  </div>
</div>
</div>
</div>
<div class="row-fluid">
  <div id="footer" class="span12"> 2012 &copy; Marutii Admin. Brought to you by <a href="http://themedesigner.in">Themedesigner.in</a> </div>
</div>
<script src="{% static 'js/excanvas.min.js'%}"></script> 
<script src="{% static 'js/jquery.min.js'%}"></script> 
<script src="{% static 'js/jquery.ui.custom.js'%}"></script> 
<script src="{% static 'js/bootstrap.min.js'%}"></script> 
<script src="{% static 'js/jquery.flot.min.js'%}"></script> 
<script src="{% static 'js/jquery.flot.resize.min.js'%}"></script> 
<script src="{% static 'js/jquery.peity.min.js'%}"></script> 
<script src="{% static 'js/fullcalendar.min.js'%}"></script> 
<script src="{% static 'js/maruti.js'%}"></script> 
<script src="{% static 'js/maruti.dashboard.js'%}"></script> 
<script src="{% static 'js/maruti.chat.js'%}"></script> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-storage.js"></script>

<script type="text/javascript">
var firebaseConfig = {
    apiKey: "AIzaSyBSIAwxO5geJSslxclj68G33dZ-yumOEMI",
    authDomain: "mapstec-81290.firebaseapp.com",
    databaseURL: "https://mapstec-81290.firebaseio.com",
    projectId: "mapstec-81290",
    storageBucket: "mapstec-81290.appspot.com",
    messagingSenderId: "99396857968",
    appId: "1:99396857968:web:d1023241ff1551546004b5",
    measurementId: "G-85RHV43HWV"
  };
  firebase.initializeApp(firebaseConfig);

  function uploadimage(){
  var storage = firebase.storage();
  var file = document.getElementById("files").files[0];
  var storageRef = storage.ref();
  var thisref = storageRef.child(file.name).put(file);
  thisref.then(snapshot => snapshot.ref.getDownloadURL())
  .then((url) => {
    console.log(url);
    $("#url").val(url);
  })
  .catch(console.error);
    }



document.getElementById("titulo").onkeypress = function(e) {
    var chr = String.fromCharCode(e.which);
    if ("></\"".indexOf(chr) >= 0)
        return false;
};
document.getElementById("descripcion").onkeypress = function(e) {
    var chr = String.fromCharCode(e.which);
    if ("></\"".indexOf(chr) >= 0)
        return false;
};

function readURL(input) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    
    reader.onload = function(e) {
      $('#preview').attr('src', e.target.result);
      $('#v_preview').attr('src', e.target.result);
    }
    
    reader.readAsDataURL(input.files[0]);
  }
}

$("#files").change(function() {
  readURL(this);
});               
var options = {
    tomas_aquino: ["Menu Principal Espacio 1","Menu Principal Espacio 2", "Calafornix Espacio 1","Calafornix Espacio 2", "Audio Visual Espacio 1","Audio Visual Espacio 2","Aula Magna Espacio 1","Aula Magna Espacio 2"],
Otay: ["lugar1", "lugar2", "lugar3"],
};
$(function(){
  $('#escuela').change(function() {
    var x= $('#escuela').val();
    $('#g_ubicacion').html("");
    for(index in options[x]) {
        $('#g_ubicacion').append('<option value="' + options[x][index] + '">' + options[x][index] + '</option>')
    };
  }).change();  
;})

$("#create_event").submit(function(event){
  var delayInMilliseconds = 10000; //1 second
  document.getElementById("crear").disabled = true;

    console.log("new event created");
    uploadimage()
    event.preventDefault();
    setTimeout(function() {
    let _titulo = $("#titulo").val();
    let _desc = $("#descripcion").val();
    let _escuela = $('#escuela').val()
    let _ubica = $( "#g_ubicacion option:selected" ).val();
    let url = $('#url').val();
    console.log(_ubica)
    let _db_path = route(_escuela,_ubica)
    console.log(route(_escuela,_ubica),url);
    event.preventDefault();

  //your code to be executed after 1 second
    $.ajax({
            type:'POST',
            url: "{% url 'fb_crear' %}",
            data:{
                'titulo':_titulo,
                'descripcion':_desc,
                'escuela':_escuela,
                'ubicacion':_db_path,
                'img':url
            },success:function(data){
              alert("Nuevo evento creado")
              location.reload();
            }
        })
      }, delayInMilliseconds);

});

function route(escuela,text){
    let _path;
    if (escuela == "tomas_aquino") { 
    switch(text){
        case "Menu Principal Espacio 1":
        _path = 'menu_principal_1'
        break;
        case "Menu Principal Espacio 2":
        _path = 'menu_principal_2'
        break;
        case "Calafornix Espacio 1":
        _path = "calafornix_1"
        break;
        case "Calafornix Espacio 2":
        _path = "calafornix_2"
        break;
        case "Audio Visual Espacio 1":
        _path = "audiovisual_1"
        break;
        case "Audio Visual Espacio 2":
        _path = "audiovisual_2"
        break;
        case "Aula Magna Espacio 1":
        _path = "aula_magna_1"
        break;
        case "Aula Magna Espacio 2":
        _path = "aula_magna_2"
        break;
    }
    }
    return _path
}
$("#vista_previa").click(function(){
    let _titulo = $("#titulo").val();
    let _desc = $("#descripcion").val();
    $("#v_titulo").text(_titulo)
    $("#v_descripcion").text(_desc)
})

$.ajaxSetup({ 
     beforeSend: function(xhr, settings) {
         function getCookie(name) {
             var cookieValue = null;
             if (document.cookie && document.cookie != '') {
                 var cookies = document.cookie.split(';');
                 for (var i = 0; i < cookies.length; i++) {
                     var cookie = jQuery.trim(cookies[i]);
                     // Does this cookie string begin with the name we want?
                     if (cookie.substring(0, name.length + 1) == (name + '=')) {
                         cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                         break;
                     }
                 }
             }
             return cookieValue;
         }
         if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
             // Only send the token to relative URLs i.e. locally.
             xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
         }
     } 
});

//for the preview
const $source = document.querySelector('#titulo');
const $result = document.querySelector('#v_titulo');
const $source_d = document.querySelector('#descripcion');
const $result_d = document.querySelector('#v_descripcion');
const typeHandler_t = function(e) {
  $result.innerHTML = e.target.value;
}
$source.addEventListener('input', typeHandler_t) 
$source.addEventListener('propertychange', typeHandler_t)

$(document).ready(function(){
    $("#descripcion").on("input", function(){
        // Print entered value in a div box
        $("#v_descripcion").text($(this).val());
    });
});
</script>
</body>
</html>